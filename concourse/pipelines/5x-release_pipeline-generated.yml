## ######################################################################
##            ___   ___    _  _  ___ _____   ___ ___ ___ _____
##           |   \ / _ \  | \| |/ _ \_   _| | __|   \_ _|_   _|
##           | |) | (_) | | .` | (_) || |   | _|| |) | |  | |
##           |___/ \___/  |_|\_|\___/ |_|   |___|___/___| |_|
##            _____ _  _ ___ ___   ___ ___ _    ___ _
##           |_   _| || |_ _/ __| | __|_ _| |  | __| |
##             | | | __ || |\__ \ | _| | || |__| _||_|
##             |_| |_||_|___|___/ |_| |___|____|___(_)
##
## This is a generated file. Please edit the corresponding template
## file (example: templates/pxf-tpl.yml) and regenerate the pipeline
## using appropriate tool (example: gen_pipeline.py -t pxf).
## ----------------------------------------------------------------------
## Generated by deploy at: 2019-12-02 20:18:23.006167
## Template file: pxf-tpl.yml
## ======================================================================
## GROUPS
## ======================================================================
groups:
  - name: all
    jobs:
      - compile_pxf
      - test_pxf_cdh_centos6
      - test_pxf_hdp2_ubuntu16
      - test_pxf_hdp2_multinode_gpdb
      - test_pxf_secure_dataproc_multinode_with_impersonation
      - test_pxf_s3_no_impersonation
      - test_pxf_s3_with_impersonation
      - test_pxf_no_impersonation
      - test_pxf_hdp2_multinode_gpdb
      - test_pxf_hdp2_centos7_java11
      - test_pxf_mapr_centos6
      - test_pxf_hdp3_centos7
      - test_pxf_hdp3_secure_with_impersonation
      - test_pxf_secure_dataproc_multinode_no_impersonation
      - test_pxf_hdp2_centos6
      - test_pxf_adl
      - test_pxf_gs
      - test_pxf_minio
      - build_release_candidate_centos

  - name: hadoop
    jobs:
      - compile_pxf
      - test_pxf_cdh_centos6
      - test_pxf_hdp2_centos7_java11
      - test_pxf_hdp2_ubuntu16
      - test_pxf_hdp2_multinode_gpdb
      - test_pxf_secure_dataproc_multinode_with_impersonation
      - test_pxf_mapr_centos6
      - test_pxf_hdp3_centos7
      - test_pxf_hdp2_centos6
      - test_pxf_secure_dataproc_multinode_no_impersonation

  - name: cloud
    jobs:
      - compile_pxf
      - test_pxf_s3_no_impersonation
      - test_pxf_s3_with_impersonation
      - test_pxf_adl
      - test_pxf_gs
      - test_pxf_minio

  - name: secure
    jobs:
      - compile_pxf
      - test_pxf_hdp3_secure_with_impersonation
      - test_pxf_secure_dataproc_multinode_no_impersonation
      - test_pxf_secure_dataproc_multinode_with_impersonation

  - name: no_impersonation
    jobs:
      - compile_pxf
      - test_pxf_no_impersonation
      - test_pxf_s3_no_impersonation
      - test_pxf_adl
      - test_pxf_gs
      - test_pxf_minio

## ======================================================================
## ANCHORS
## ======================================================================
ccp_destroy_anchor: &ccp_destroy
  do:
  - put: terraform_gpdb
    resource: terraform
    params:
      action: destroy
      env_name_file: terraform_gpdb/name
      terraform_source: ccp_src/google/
    get_params:
      action: destroy

dataproc_destroy_anchor: &dataproc_destroy
  do:
  - in_parallel:
    - task: Cleanup Dataproc 1
      config:
        run:
          path: pxf_src/concourse/scripts/cleanup_dataproc_cluster.bash
        inputs:
          - name: pxf_src
          - name: dataproc_env_files
        platform: linux
      image: ccp-7
      params:
        GOOGLE_CREDENTIALS: {{google-service-account-key}}
        GOOGLE_PROJECT_ID: {{google-project-id}}
        GOOGLE_ZONE: {{google-zone}}
    - task: Cleanup Dataproc 2
      input_mapping:
        dataproc_env_files: dataproc_2_env_files
      config:
        run:
          path: pxf_src/concourse/scripts/cleanup_dataproc_cluster.bash
        inputs:
          - name: pxf_src
          - name: dataproc_env_files
        platform: linux
      image: ccp-7
      params:
        GOOGLE_CREDENTIALS: ((data-gpdb-ud-kerberos-google-service-account-key))
        GOOGLE_PROJECT_ID: ((data-gpdb-ud-kerberos-google-project-id))
        GOOGLE_ZONE: ((data-gpdb-ud-kerberos-google-zone))
    - put: terraform_gpdb
      resource: terraform
      params:
        action: destroy
        env_name_file: terraform_gpdb/name
        terraform_source: ccp_src/google/
      get_params:
        action: destroy

dataproc_timed_destroy_anchor: &dataproc_timed_destroy
  do:
  - task: debug_sleep
    image: ccp-7
    config:
      run:
        path: /bin/sleep
        args: [{{dataproc-destroy-timeout}}]
      platform: linux
  - in_parallel:
    - task: Cleanup Dataproc 1
      config:
        run:
          path: pxf_src/concourse/scripts/cleanup_dataproc_cluster.bash
        inputs:
          - name: pxf_src
          - name: dataproc_env_files
        platform: linux
      image: ccp-7
      params:
        GOOGLE_CREDENTIALS: {{google-service-account-key}}
        GOOGLE_PROJECT_ID: {{google-project-id}}
        GOOGLE_ZONE: {{google-zone}}
    - task: Cleanup Dataproc 2
      input_mapping:
        dataproc_env_files: dataproc_2_env_files
      config:
        run:
          path: pxf_src/concourse/scripts/cleanup_dataproc_cluster.bash
        inputs:
          - name: pxf_src
          - name: dataproc_env_files
        platform: linux
      image: ccp-7
      params:
        GOOGLE_CREDENTIALS: ((data-gpdb-ud-kerberos-google-service-account-key))
        GOOGLE_PROJECT_ID: ((data-gpdb-ud-kerberos-google-project-id))
        GOOGLE_ZONE: ((data-gpdb-ud-kerberos-google-zone))

## ======================================================================
## RESOURCE TYPES
## ======================================================================
resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource
    tag: 0.11.14

## ======================================================================
## RESOURCES
## ======================================================================
resources:

- name: ccp_src
  type: git
  source:
    branch: {{ccp-git-branch}}
    private_key: {{ccp-git-key}}
    uri: {{ccp-git-remote}}

- name: gpdb_src
  type: git
  source:
    branch: {{gpdb-branch}}
    uri: {{gpdb-git-remote}}

- name: pxf_src
  type: git
  source:
    branch: {{pxf-git-branch}}
    uri: {{pxf-git-remote}}
    tag_filter: 5.*

- name: gpdb-pxf-dev-centos6
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos6

- name: gpdb-pxf-dev-centos6-cdh-server
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos6-cdh-server

- name: gpdb-pxf-dev-centos6-hdp2-server
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos6-hdp2-server

- name: gpdb-pxf-dev-centos7-hdp2-server
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7-hdp2-server

- name: gpdb-pxf-dev-centos7-hdp3-server
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos7-hdp3-server

- name: gpdb-pxf-dev-centos6-mapr-image
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: centos6-mapr-server

- name: gpdb-pxf-dev-ubuntu16-hdp2-server
  type: docker-image
  source:
    repository: pivotaldata/gpdb-pxf-dev
    tag: ubuntu16-hdp2-server

- name: ccp-7
  type: docker-image
  source:
    repository: pivotaldata/ccp
    tag: 7

- name: bin_gpdb_centos6
  type: s3
  source:
    access_key_id: {{bucket-access-key-id}}
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    bucket: {{gpdb-stable-builds-bucket-name}}
    versioned_file: release_candidates/bin_gpdb_centos6/gpdb5/bin_gpdb.tar.gz

- name: bin_gpdb_centos7
  type: s3
  source:
    access_key_id: {{bucket-access-key-id}}
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    bucket: {{gpdb-stable-builds-bucket-name}}
    versioned_file: release_candidates/bin_gpdb_centos7/gpdb5/bin_gpdb.tar.gz

- name: bin_gpdb_ubuntu16
  type: s3
  source:
    access_key_id: {{bucket-access-key-id}}
    bucket: gpdb5-stable-concourse-builds
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    versioned_file: bin_gpdb_ubuntu16/bin_gpdb.tar.gz

- name: pxf_tarball
  type: s3
  source:
    access_key_id: {{bucket-access-key-id}}
    bucket: {{pxf-aws-bucket-name}}
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    versioned_file: pxf_artifacts/((folder-prefix))_((gpdb-branch))/latest/pxf.tar.gz

- name: component_pxf
  type: s3
  source:
    access_key_id: {{bucket-access-key-id}}
    bucket: gpdb-stable-concourse-builds
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    regexp: components/pxf/pxf-(.*).tar.gz

- name: gpdb_release
  type: git
  source:
    branch: {{gpdb-release-branch}}
    private_key: {{gpdb-release-remote-deploy-key}}
    uri: {{gpdb-release-git-remote}}

- name: terraform
  type: terraform
  source:
    env:
      AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      GOOGLE_CREDENTIALS: {{google-service-account-key}}
    vars:
      project_id: {{google-project-id}}
    storage:
      access_key_id: {{tf-machine-access-key-id}}
      secret_access_key: {{tf-machine-secret-access-key}}
      region_name: {{aws-region}}
      bucket: {{tf-bucket-name}}
      bucket_path: {{tf-bucket-path}}

## ======================================================================
## JOBS
## ======================================================================
jobs:

- name: compile_pxf
  plan:
  - in_parallel:
    - get: gpdb_src
    - get: pxf_src
      trigger: true
    - get: gpdb-pxf-dev-centos6
  - task: compile_pxf
    image: gpdb-pxf-dev-centos6
    file: pxf_src/concourse/tasks/compile_pxf.yml
  - put: pxf_tarball
    params:
      file: pxf_artifacts/pxf.tar.gz

- name: test_pxf_hdp2_centos6
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-hdp2-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-hdp2-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: gpdb,proxy,profile
      HADOOP_CLIENT: HDP
      PGPORT: {{pgport}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TARGET_OS_VERSION: 6
      TEST_ENV: {{test-env}}

- name: test_pxf_mapr_centos6
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-mapr-image
  - task: test_pxf
    privileged: true
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-mapr-image
    params:
      GROUP: hcfs,jdbc
      HADOOP_CLIENT: MAPR
      PGPORT: {{pgport}}
      TARGET_OS: centos
      TARGET_OS_VERSION: 6
      TEST_ENV: {{test-env}}

- name: test_pxf_hdp3_centos7
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos7
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos7-hdp3-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos7-hdp3-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: gpdb,proxy,profile
      HADOOP_CLIENT: HDP
      PGPORT: {{pgport}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
      TEST_ENV: {{test-env}}

- name: test_pxf_hdp2_centos7_java11
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos7
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos7-hdp2-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos7-hdp2-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: cloud-access-and-hdfs,hbase,hcfs,jdbc,profile,pushdown
      HADOOP_CLIENT: HDP
      PGPORT: {{pgport}}
      RUN_JDK_VERSION: 11
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TARGET_OS_VERSION: 7
      TEST_ENV: {{test-env}}

- name: test_pxf_hdp2_ubuntu16
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_ubuntu16
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-ubuntu16-hdp2-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-ubuntu16-hdp2-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: gpdb,proxy,profile
      HADOOP_CLIENT: HDP
      PGPORT: {{pgport}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TEST_OS: ubuntu
      TARGET_OS: ubuntu
      TARGET_OS_VERSION: 16
      TEST_ENV: {{test-env}}

- name: test_pxf_hdp3_secure_with_impersonation
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos7-hdp3-server
    - get: ccp-7
  - task: load_config_for_ambari
    file: pxf_src/concourse/tasks/load_ambari_config.yml
    image: ccp-7
    params:
      GOOGLE_CREDENTIALS: {{google-service-account-key}}
      GOOGLE_PROJECT_ID: {{google-project-id}}
      GOOGLE_ZONE: {{google-zone}}
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos7-hdp3-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: security
      HADOOP_CLIENT: HDP_KERBEROS
      IMPERSONATION: true
      PGPORT: {{pgport}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TEST_ENV: {{test-env}}

- name: test_pxf_hdp2_multinode_gpdb
  max_in_flight: 2
  plan:
  - get: ccp_src
  - get: gpdb_src
    passed:
    - compile_pxf
  - get: gpdb_binary
    resource: bin_gpdb_centos6
  - get: pxf_src
    passed:
    - compile_pxf
    trigger: true
  - get: pxf_tarball
    passed:
    - compile_pxf
    trigger: true
  - get: ccp-7
  - get: gpdb-pxf-dev-centos6-hdp2-server
  - put: terraform_gpdb
    resource: terraform
    params:
      action: create
      delete_on_failure: true
      generate_random_name: true
      terraform_source: ccp_src/google/
      vars:
        PLATFORM: centos7
        number_of_nodes: {{number_of_gpdb_nodes}}
        extra_nodes: 1
        segments_per_host: 4
        instance_type: n1-standard-4
        ccp_reap_minutes: 120
  - task: gen_gpdb_cluster
    input_mapping:
      terraform: terraform_gpdb
    file: ccp_src/ci/tasks/gen_cluster.yml
    image: ccp-7
    params:
      AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      AWS_DEFAULT_REGION: {{aws-region}}
      BUCKET_PATH: {{tf-bucket-path}}
      BUCKET_NAME: {{tf-bucket-name}}
      PLATFORM: centos7
      CLOUD_PROVIDER: google
  - in_parallel:
    - task: Initialize Greenplum
      file: ccp_src/ci/tasks/gpinitsystem.yml
    - task: Install Hadoop
      file: pxf_src/concourse/tasks/install_hadoop.yml
      image: gpdb-pxf-dev-centos6-hdp2-server
      params:
        ACCESS_KEY_ID: {{tf-machine-access-key-id}}
        SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
        IMPERSONATION: {{enable-impersonation-multinode}}
  - task: Setup PXF
    input_mapping:
      terraform: terraform_gpdb
      bin_gpdb: gpdb_binary
    file: pxf_src/concourse/tasks/install_pxf.yml
    image: ccp-7
    params:
      AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      AWS_DEFAULT_REGION: {{aws-region}}
      BUCKET_PATH: {{tf-bucket-path}}
      BUCKET_NAME: {{tf-bucket-name}}
      CLOUD_PROVIDER: google
      IMPERSONATION: {{enable-impersonation-multinode}}
      INSTALL_GPHDFS: false
      PLATFORM: centos7
      PXF_JVM_OPTS: {{pxf-jvm-opts}}
  - task: Test PXF Multinode
    input_mapping:
      bin_gpdb: gpdb_binary
    on_success:
      <<: *ccp_destroy
    image: gpdb-pxf-dev-centos6-hdp2-server
    file: pxf_src/concourse/tasks/test_pxf_multinode.yml
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: gpdb,proxy
      IMPERSONATION: {{enable-impersonation-multinode}}
      PGPORT: {{pgport}}
      PXF_JVM_OPTS: {{pxf-jvm-opts}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos

- name: test_pxf_secure_dataproc_multinode_with_impersonation
  max_in_flight: 2
  plan:
  - in_parallel:
    - get: ccp_src
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: gpdb_binary
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: ccp-7
    - get: gpdb-pxf-dev-centos6-hdp2-server
  - in_parallel:
    - do:
      - put: terraform_gpdb
        resource: terraform
        params:
          action: create
          delete_on_failure: true
          generate_random_name: true
          terraform_source: ccp_src/google/
          vars:
            PLATFORM: centos7
            number_of_nodes: {{number_of_gpdb_nodes}}
            extra_nodes: 1
            segments_per_host: 4
            instance_type: n1-standard-4
            ccp_reap_minutes: 120
      - task: Generate Greenplum Cluster
        input_mapping:
          terraform: terraform_gpdb
        file: ccp_src/ci/tasks/gen_cluster.yml
        image: ccp-7
        params:
          AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
          AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
          AWS_DEFAULT_REGION: {{aws-region}}
          BUCKET_PATH: {{tf-bucket-path}}
          BUCKET_NAME: {{tf-bucket-name}}
          PLATFORM: centos7
          CLOUD_PROVIDER: google
      - in_parallel:
        - task: Initialize Greenplum
          file: ccp_src/ci/tasks/gpinitsystem.yml
        - task: Install Hadoop
          file: pxf_src/concourse/tasks/install_hadoop.yml
          image: gpdb-pxf-dev-centos6-hdp2-server
          params:
            ACCESS_KEY_ID: {{tf-machine-access-key-id}}
            SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
            IMPERSONATION: {{enable-impersonation-multinode}}
    - task: Generate Hadoop Cluster 1
      file: pxf_src/concourse/tasks/install_dataproc.yml
      image: ccp-7
      params:
        GOOGLE_CREDENTIALS: {{google-service-account-key}}
        GOOGLE_PROJECT_ID: {{google-project-id}}
        GOOGLE_ZONE: {{google-zone}}
        IMAGE_VERSION: {{dataproc-image-version}}
        KERBEROS: {{kerberos-enabled}}
    - task: Generate Hadoop Cluster 2
      file: pxf_src/concourse/tasks/install_dataproc.yml
      image: ccp-7
      output_mapping:
        dataproc_env_files: dataproc_2_env_files
      params:
        GOOGLE_CREDENTIALS: ((data-gpdb-ud-kerberos-google-service-account-key))
        GOOGLE_PROJECT_ID: ((data-gpdb-ud-kerberos-google-project-id))
        GOOGLE_ZONE: ((data-gpdb-ud-kerberos-google-zone))
        HADOOP_USER: gpuser
        IMAGE_VERSION: {{dataproc-image-version}}
        INITIALIZATION_SCRIPT: gs://data-gpdb-ud-kerberos-scripts/scripts/initialization-for-kerberos.sh
        INSTANCE_TAGS: bosh-network,data-gpdb-ud-access
        KERBEROS: {{kerberos-enabled}}
        KEY: dataproc-kerberos-key
        KEYRING: dataproc-kerberos
        NO_ADDRESS: false
        PROXY_USER: gpuser
        SECRETS_BUCKET: data-gpdb-ud-kerberos-pxf-secrets
  - task: Setup PXF
    input_mapping:
      terraform: terraform_gpdb
      bin_gpdb: gpdb_binary
    file: pxf_src/concourse/tasks/install_pxf.yml
    image: ccp-7
    params:
      AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      AWS_DEFAULT_REGION: {{aws-region}}
      BUCKET_PATH: {{tf-bucket-path}}
      BUCKET_NAME: {{tf-bucket-name}}
      CLOUD_PROVIDER: google
      IMPERSONATION: {{enable-impersonation-multinode}}
      INSTALL_GPHDFS: false
      KERBEROS: {{kerberos-enabled}}
      PLATFORM: centos7
      PXF_JVM_OPTS: {{pxf-jvm-opts}}
    on_failure:
      <<: *dataproc_timed_destroy
  - task: Test PXF Multinode
    input_mapping:
      bin_gpdb: gpdb_binary
    on_success:
      <<: *dataproc_destroy
    on_failure:
      <<: *dataproc_timed_destroy
    image: gpdb-pxf-dev-centos6-hdp2-server
    file: pxf_src/concourse/tasks/test_pxf_multinode.yml
    attempts: 2
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      HIVE_VERSION: 2
      IMPERSONATION: {{enable-impersonation-multinode}}
      KERBEROS: {{kerberos-enabled}}
      GOOGLE_PROJECT_ID: {{google-project-id}}
      GROUP: security,proxySecurity,multiClusterSecurity
      PXF_JVM_OPTS: {{pxf-jvm-opts}}
      TARGET_OS: centos

- name: test_pxf_secure_dataproc_multinode_no_impersonation
  max_in_flight: 2
  plan:
  - in_parallel:
    - get: ccp_src
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: gpdb_binary
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: ccp-7
    - get: gpdb-pxf-dev-centos6-hdp2-server
  - in_parallel:
    - do:
      - put: terraform_gpdb
        resource: terraform
        params:
          action: create
          delete_on_failure: true
          generate_random_name: true
          terraform_source: ccp_src/google/
          vars:
            PLATFORM: centos7
            number_of_nodes: {{number_of_gpdb_nodes}}
            extra_nodes: 1
            segments_per_host: 4
            instance_type: n1-standard-4
            ccp_reap_minutes: 120
      - task: Generate Greenplum Cluster
        input_mapping:
          terraform: terraform_gpdb
        file: ccp_src/ci/tasks/gen_cluster.yml
        image: ccp-7
        params:
          AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
          AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
          AWS_DEFAULT_REGION: {{aws-region}}
          BUCKET_PATH: {{tf-bucket-path}}
          BUCKET_NAME: {{tf-bucket-name}}
          PLATFORM: centos7
          CLOUD_PROVIDER: google
      - in_parallel:
        - task: Initialize Greenplum
          file: ccp_src/ci/tasks/gpinitsystem.yml
        - task: Install Hadoop
          file: pxf_src/concourse/tasks/install_hadoop.yml
          image: gpdb-pxf-dev-centos6-hdp2-server
          params:
            ACCESS_KEY_ID: {{tf-machine-access-key-id}}
            SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
            IMPERSONATION: {{enable-impersonation-multinode}}
    - task: Generate Hadoop Cluster 1
      file: pxf_src/concourse/tasks/install_dataproc.yml
      image: ccp-7
      params:
        GOOGLE_CREDENTIALS: {{google-service-account-key}}
        GOOGLE_PROJECT_ID: {{google-project-id}}
        GOOGLE_ZONE: {{google-zone}}
        IMAGE_VERSION: {{dataproc-image-version}}
        KERBEROS: {{kerberos-enabled}}
    - task: Generate Hadoop Cluster 2
      file: pxf_src/concourse/tasks/install_dataproc.yml
      image: ccp-7
      output_mapping:
        dataproc_env_files: dataproc_2_env_files
      params:
        GOOGLE_CREDENTIALS: ((data-gpdb-ud-kerberos-google-service-account-key))
        GOOGLE_PROJECT_ID: ((data-gpdb-ud-kerberos-google-project-id))
        GOOGLE_ZONE: ((data-gpdb-ud-kerberos-google-zone))
        HADOOP_USER: gpuser
        IMAGE_VERSION: {{dataproc-image-version}}
        INITIALIZATION_SCRIPT: gs://data-gpdb-ud-kerberos-scripts/scripts/initialization-for-kerberos.sh
        INSTANCE_TAGS: bosh-network,data-gpdb-ud-access
        KERBEROS: {{kerberos-enabled}}
        KEY: dataproc-kerberos-key
        KEYRING: dataproc-kerberos
        NO_ADDRESS: false
        PROXY_USER: gpuser
        SECRETS_BUCKET: data-gpdb-ud-kerberos-pxf-secrets
  - task: Setup PXF
    input_mapping:
      terraform: terraform_gpdb
      bin_gpdb: gpdb_binary
    file: pxf_src/concourse/tasks/install_pxf.yml
    image: ccp-7
    params:
      AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      AWS_DEFAULT_REGION: {{aws-region}}
      BUCKET_PATH: {{tf-bucket-path}}
      BUCKET_NAME: {{tf-bucket-name}}
      CLOUD_PROVIDER: google
      IMPERSONATION: {{enable-impersonation-multinode}}
      INSTALL_GPHDFS: false
      KERBEROS: {{kerberos-enabled}}
      PLATFORM: centos7
      PXF_JVM_OPTS: {{pxf-jvm-opts}}
    on_failure:
      <<: *dataproc_timed_destroy
  - task: Test PXF Multinode
    input_mapping:
      bin_gpdb: gpdb_binary
    on_success:
      <<: *dataproc_destroy
    on_failure:
      <<: *dataproc_timed_destroy
    image: gpdb-pxf-dev-centos6-hdp2-server
    file: pxf_src/concourse/tasks/test_pxf_multinode.yml
    attempts: 2
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      HIVE_VERSION: 2
      IMPERSONATION: false
      KERBEROS: {{kerberos-enabled}}
      GOOGLE_PROJECT_ID: {{google-project-id}}
      GROUP: security,multiClusterSecurity
      PXF_JVM_OPTS: {{pxf-jvm-opts}}
      TARGET_OS: centos

- name: test_pxf_cdh_centos6
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-cdh-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-cdh-server
    attempts: 2
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: gpdb,proxy,profile
      HADOOP_CLIENT: CDH
      PGPORT: {{pgport}}
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TEST_ENV: {{test-env}}

- name: test_pxf_s3_no_impersonation
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-cdh-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-cdh-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: hcfs,s3
      IMPERSONATION: false
      PGPORT: {{pgport}}
      PROTOCOL: s3
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TEST_ENV: {{test-env}}
      TEST_OS: centos

- name: test_pxf_s3_with_impersonation
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-hdp2-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-hdp2-server
    params:
      ACCESS_KEY_ID: {{tf-machine-access-key-id}}
      GROUP: hcfs,s3
      IMPERSONATION: true
      PGPORT: {{pgport}}
      PROTOCOL: s3
      SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
      TARGET_OS: centos
      TEST_ENV: {{test-env}}
      TEST_OS: centos

- name: test_pxf_minio
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-hdp2-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-hdp2-server
    params:
      GROUP: hcfs
      IMPERSONATION: false
      PGPORT: {{pgport}}
      PROTOCOL: minio
      TARGET_OS: centos
      TEST_ENV: {{test-env}}
      TEST_OS: centos

- name: test_pxf_adl
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-cdh-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-cdh-server
    params:
      ADL_ACCOUNT: {{adl-account}}
      ADL_CLIENT_ID: {{adl-client-id}}
      ADL_CREDENTIAL: {{adl-credential}}
      ADL_REFRESH_URL: {{adl-refresh-url}}
      GROUP: hcfs
      IMPERSONATION: false
      PGPORT: {{pgport}}
      PROTOCOL: adl
      TARGET_OS: centos
      TEST_ENV: {{test-env}}
      TEST_OS: centos

- name: test_pxf_gs
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-cdh-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-cdh-server
    params:
      GOOGLE_CREDENTIALS: {{data-gpdb-ud-google-json-key}}
      GROUP: hcfs
      IMPERSONATION: false
      PGPORT: {{pgport}}
      PROTOCOL: gs
      TARGET_OS: centos
      TEST_ENV: {{test-env}}
      TEST_OS: centos

- name: test_pxf_no_impersonation
  plan:
  - in_parallel:
    - get: gpdb_src
      passed:
      - compile_pxf
    - get: bin_gpdb
      resource: bin_gpdb_centos6
    - get: pxf_src
      passed:
      - compile_pxf
      trigger: true
    - get: pxf_tarball
      passed:
      - compile_pxf
      trigger: true
    - get: gpdb-pxf-dev-centos6-hdp2-server
  - task: test_pxf
    file: pxf_src/concourse/tasks/test_pxf.yml
    image: gpdb-pxf-dev-centos6-hdp2-server
    params:
      IMPERSONATION: false
      PGPORT: {{pgport}}
      TARGET_OS: centos
      TEST_ENV: {{test-env}}

- name: build_release_candidate_centos
  plan:
  - get: ccp-7
  - get: gpdb-pxf-dev-centos6
  - get: pxf_tarball
    passed:
    - test_pxf_hdp2_centos6
    - test_pxf_hdp2_centos7_java11
    - test_pxf_cdh_centos6
    - test_pxf_mapr_centos6
    - test_pxf_hdp3_centos7
    - test_pxf_hdp2_ubuntu16
    - test_pxf_adl
    - test_pxf_gs
    - test_pxf_minio
    - test_pxf_s3_no_impersonation
    - test_pxf_s3_with_impersonation
    - test_pxf_hdp3_secure_with_impersonation
    - test_pxf_no_impersonation
    - test_pxf_hdp2_multinode_gpdb
    - test_pxf_secure_dataproc_multinode_with_impersonation
    - test_pxf_secure_dataproc_multinode_no_impersonation
    trigger: true
  - get: gpdb_release
  - get: pxf_src
    passed:
    - test_pxf_hdp2_centos6
    - test_pxf_hdp2_centos7_java11
    - test_pxf_cdh_centos6
    - test_pxf_mapr_centos6
    - test_pxf_hdp3_centos7
    - test_pxf_hdp2_ubuntu16
    - test_pxf_adl
    - test_pxf_gs
    - test_pxf_minio
    - test_pxf_s3_no_impersonation
    - test_pxf_s3_with_impersonation
    - test_pxf_hdp3_secure_with_impersonation
    - test_pxf_no_impersonation
    - test_pxf_hdp2_multinode_gpdb
    - test_pxf_secure_dataproc_multinode_with_impersonation
    - test_pxf_secure_dataproc_multinode_no_impersonation
  - task: package_pxf_rc
    config:
      inputs:
      - name: pxf_src
      - name: pxf_tarball
      outputs:
      - name: pxf_artifacts
      platform: linux
      run:
        path: pxf_src/concourse/scripts/package_pxf_rc.bash
    image: gpdb-pxf-dev-centos6
  - task: update_manifest
    image: ccp-7
    file: pxf_src/concourse/tasks/release_update_manifest.yml
  - put: component_pxf
    params:
      file: pxf_artifacts/pxf-*.tar.gz
  - put: gpdb_release
    params:
      repository: gpdb_release_output
      rebase: true
